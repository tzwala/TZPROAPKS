<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TZPROAPKS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, increment, onSnapshot, setDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7iYEqX8F2dcEmu0b24204e8HZukliW3A",
            authDomain: "only-tutorial.firebaseapp.com",
            databaseURL: "https://only-tutorial-default-rtdb.firebaseio.com",
            projectId: "only-tutorial",
            storageBucket: "only-tutorial.firebasestorage.app",
            messagingSenderId: "575819390623",
            appId: "1:575819390623:web:6cba9f497a990b2f87ccaa",
            measurementId: "G-1BNYB97LMQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Export Firebase functions to global scope
        window.auth = auth;
        window.db = db;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.increment = increment;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
    </script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #f5f7fa, #e4e7eb);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        #app {
            width: 100%;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        @screen sm {
            #app { max-width: 56rem; }
        }

        .flutter-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .flutter-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .flutter-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .flutter-button:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .flutter-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s, opacity 0.3s;
        }
        .flutter-button:active::after {
            width: 200px;
            height: 200px;
            opacity: 1;
            transition: 0s;
        }

        .drawer {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 75%;
            max-width: 18rem;
        }
        @media (max-width: 360px) {
            .drawer {
                width: 85%;
                max-width: none;
            }
        }

        .overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .app-container {
            animation: fadeIn 0.5s ease-in-out;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .app-content {
            flex: 1;
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 6px;
            /* Removed max-height: 100vh and overflow: hidden */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-icon {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /%3E%3C/svg%3E');
            background-position: 12px center;
            background-repeat: no-repeat;
            background-size: 20px;
            padding-left: 40px;
        }
        .input-icon.password {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.1-.9-2-2-2s-2 .9-2 2c0 .74.4 1.38 1 1.73V15h2v-2.27c.6-.35 1-.99 1-1.73zm7-2v6c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h1V5c0-1.66 1.34-3 3-3s3 1.34 3 3v2h1c1.1 0 2 .9 2 2z" /%3E%3C/svg%3E');
        }
        .input-icon.search {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /%3E%3C/svg%3E');
        }
        .input-icon.url {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.393 0l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /%3E%3C/svg%3E');
        }
        .input-icon.text {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%239ca3af"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-3m-2 8a3 3 0 11-6 0 3 3 0 016 0zM7.5 14h.01" /%3E%3C/svg%3E');
        }

        .app-bar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(to right, #2563eb, #3b82f6);
            padding: 4px 6px;
            width: 100%;
        }
        .search-container {
            transition: all 0.3s ease-in-out;
        }
        .search-container:focus-within {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .star-rating .star {
            cursor: pointer;
            transition: color 0.2s ease;
            font-size: 1.5rem;
            color: #d1d5db;
        }
        .star-rating .star:hover,
        .star-rating .star.active {
            color: #f59e0b;
        }

        #messageArea {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            margin-left: 1rem;
            margin-right: 1rem;
        }
        @screen sm {
            #messageArea {
                margin-left: 0;
                margin-right: 0;
            }
        }

        #messageArea.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        #messageArea.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #messageArea.info {
            background-color: #e0f2f7;
            color: #0e7490;
        }
        #messageArea.hidden {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        #loadingIndicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #4b5563;
            font-size: 1.1rem;
        }

        #loadingIndicator svg {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid-cols-auto-fit-minmax {
            grid-template-columns: repeat(auto-fit, minmax(var(--auto-fit-minmax-width), 1fr));
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .footer-buttons {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 10px 6px;
            border-top: 1px solid #e5e7eb;
            width: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .footer-buttons button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 0;
            position: relative;
        }

        .footer-buttons button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin-left: -10px;
        }

        .footer-buttons button.downloaded {
            background-color: #4ade80;
            color: #fff;
        }

        .footer-buttons button.downloaded:hover {
            background-color: #22c55e;
        }

        .rating-details {
            background: #f9fafb;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e0f2fe;
            color: #075985;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .verified-badge::before {
            content: '';
            width: 12px;
            height: 12px;
            background: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23075985"%3E%3Cpath d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" /%3E%3C/svg%3E') no-repeat center;
            background-size: contain;
        }
    </style>
</head>
<body>
    <div id="app" class="bg-white app-container"></div>

    <script>
        // --- Utility Functions ---

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        let messageTimeout;
        function showMessage(type, text, duration = 5000) {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) {
                console.log(`Message (${type}): ${text}`);
                return;
            }

            clearTimeout(messageTimeout);

            messageArea.classList.remove('hidden', 'success', 'error', 'info');
            messageArea.classList.add(type);
            messageArea.textContent = text;

            messageTimeout = setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.textContent = '';
            }, duration);
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.toggle('hidden', !show);
            }
            const appList = document.getElementById('appList');
            if (appList) {
                appList.classList.toggle('hidden', show);
            }
            const noResults = document.getElementById('noResults');
            if (noResults) {
                noResults.classList.add('hidden');
            }
            const manageAppList = document.getElementById('manageAppList');
            if (manageAppList) {
                manageAppList.classList.toggle('hidden', show);
            }
            const noUserApps = document.getElementById('noUserApps');
            if (noUserApps) {
                noUserApps.classList.add('hidden');
            }
        }

        function toggleDrawer() {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('overlay');
            if (drawer && overlay) {
                const isOpen = !drawer.classList.contains('-translate-x-full');
                if (isOpen) {
                    drawer.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                } else {
                    drawer.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                }
            } else {
                console.error('Drawer or overlay element not found');
            }
        }

        function closeDrawer() {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('overlay');
            if (drawer && overlay) {
                drawer.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                console.error('Drawer or overlay element not found');
            }
        }

        // --- Page Rendering Functions ---

        function showLoginPage() {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="flex-1 p-6 sm:p-8 app-content">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 sm:mb-8 text-gray-900">Welcome Back</h2>
                    <div id="messageArea" class="hidden"></div>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon" required>
                        </div>
                        <div>
                            <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon password" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 sm:p-4 rounded-xl hover:bg-blue-700 flutter-button font-bold">Login</button>
                        <p class="text-center text-gray-600 text-sm sm:text-base">Don't have an account? <a href="#" onclick="showSignUpPage()" class="text-blue-600 hover:underline font-medium">Sign Up</a></p>
                    </form>
                </div>
            `;
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        function showSignUpPage() {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="flex-1 p-6 sm:p-8 app-content">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 sm:mb-8 text-gray-900">Create Account</h2>
                    <div id="messageArea" class="hidden"></div>
                    <form id="signupForm" class="space-y-6">
                        <div>
                            <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon" required>
                        </div>
                        <div>
                            <input type="text" id="signupUsername" placeholder="Username" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon text" required>
                        </div>
                        <div>
                            <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon password" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 sm:p-4 rounded-xl hover:bg-blue-700 flutter-button font-bold">Sign Up</button>
                        <p class="text-center text-gray-600 text-sm sm:text-base">Already have an account? <a href="#" onclick="showLoginPage()" class="text-blue-600 hover:underline font-medium">Login</a></p>
                    </form>
                </div>
            `;
            const signupForm = document.getElementById('signupForm');
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignUp);
            }
        }

        function showHomePage() {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="relative flex-1 flex flex-col h-full">
                    <div id="drawer" class="drawer fixed top-0 left-0 h-full bg-white shadow-2xl -translate-x-full z-50 overflow-y-auto w-64 max-w-sm sm:w-72">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-gray-900">Menu</h3>
                                <button onclick="closeDrawer()" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <ul class="space-y-3">
                                <li><button onclick="showUploadForm(); closeDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-blue-50 text-gray-800 flex items-center focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>Upload Your APK</button></li>
                                <li><button onclick="showManageApps(); closeDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-blue-50 text-gray-800 flex items-center focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Manage Your Apps</button></li>
                                <li><button onclick="handleLogout(); closeDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-red-50 text-red-600 flex items-center focus:outline-none focus:ring-2 focus:ring-red-500 text-sm sm:text-base"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Logout</button></li>
                            </ul>
                        </div>
                    </div>
                    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="closeDrawer()"></div>
                    <div class="flex flex-col flex-1">
                        <div class="app-bar">
                            <div class="flex justify-between items-center">
                                <button onclick="toggleDrawer()" class="text-white hover:opacity-80 focus:outline-none">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </button>
                                <h2 class="text-xl sm:text-2xl font-bold text-white">TZPROAPKS</h2>
                                <div class="w-7"></div>
                            </div>
                        </div>
                        <div class="p-4 sm:p-6 flex-1 app-content">
                            <div id="messageArea" class="hidden"></div>
                            <div class="search-container mb-4">
                                <input type="text" id="searchInput" placeholder="Search Apps..." class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon search" />
                            </div>
                            <div class="flex flex-col sm:flex-row justify-between mb-4 sm:mb-6 space-y-3 sm:space-y-0 space-x-0 sm:space-x-4">
                                <select id="categoryFilter" class="flex-1 p-3 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                    <option value="">All Categories</option>
                                    <option value="Games">Games</option>
                                    <option value="Productivity">Productivity</option>
                                    <option value="Social">Social</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Education">Education</option>
                                    <option value="Utilities">Utilities</option>
                                </select>
                                <select id="sortOption" class="flex-1 p-3 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                    <option value="downloads-desc">Most Downloads</option>
                                    <option value="rating-desc">Highest Rating</option>
                                </select>
                            </div>
                            <div id="loadingIndicator" class="hidden">
                                <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                    <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                                </svg>
                                <span>Loading Apps...</span>
                            </div>
                            <div id="appList" class="grid grid-cols-auto-fit-minmax gap-4 transition-all duration-300" style="--auto-fit-minmax-width: 120px;"></div>
                            <div id="noResults" class="text-center text-gray-600 mt-6 sm:mt-8 hidden text-sm sm:text-base">No apps found matching your criteria.</div>
                        </div>
                    </div>
                </div>
            `;
            const style = document.createElement('style');
            style.innerHTML += `.grid-cols-auto-fit-minmax { grid-template-columns: repeat(auto-fit, minmax(var(--auto-fit-minmax-width), 1fr)); }`;
            document.head.appendChild(style);

            loadApps();
            setupSearchAndFilters();
        }

        async function showAppDetails(app, docId) {
            cleanupListeners();
            const user = JSON.parse(localStorage.getItem('user'));
            const isOwner = user && app.userId === user.uid;
            const hasDownloaded = user ? await checkIfDownloaded(docId, user.uid) : false;
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="flex-1 flex flex-col h-full app-container">
                    <div class="app-bar">
                        <div class="flex items-center">
                            <button onclick="showHomePage()" class="mr-4 text-white hover:opacity-80 focus:outline-none">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 class="text-xl sm:text-2xl font-bold text-white truncate">${app.name}</h2>
                            ${app.isApproved ? '<span class="verified-badge ml-2">Verified</span>' : ''}
                        </div>
                    </div>
                    <div class="p-6 flex-1 app-content">
                        <div id="messageArea" class="hidden"></div>
                        <img src="${app.icon}" alt="${app.name}" class="w-24 h-24 sm:w-32 sm:h-32 mx-auto border-4 border-white object-cover">
                        <h3 class="text-xl sm:text-2xl font-bold text-center text-gray-900 mt-4">${app.name}</h3>
                        ${app.isApproved ? '<div class="text-center"><span class="verified-badge">Verified</span></div>' : ''}
                        <p class="mt-6 text-gray-700 leading-relaxed text-justify text-sm sm:text-base">${app.description}</p>
                        <div class="mt-6">
                            <h3 class="font-bold text-gray-900 mb-3 text-lg sm:text-xl">Screenshots</h3>
                            <div class="flex space-x-3 overflow-x-auto py-2 -mx-6 sm:-mx-8 px-6 sm:px-8 no-scrollbar">
                                ${app.screenshots.map(src => `<img src="${src}" class="w-32 h-auto object-cover rounded-lg sm:rounded-xl shadow-md" alt="Screenshot">`).join('')}
                            </div>
                        </div>
                        <div class="mt-6 border-t border-gray-200 pt-6 space-y-3 text-sm sm:text-base">
                            <p class="text-gray-700">Downloads: <span class="font-bold text-gray-900">${app.downloads || 0}</span></p>
                            <p class="text-gray-700">Category: <span class="font-bold text-gray-900">${app.category || 'N/A'}</span></p>
                            <div class="flex items-center text-gray-700">
                                <span>Average Rating:</span>
                                <span class="font-bold text-gray-900 ml-2" id="avgRating">${app.avgRating ? parseFloat(app.avgRating).toFixed(1) : 'No ratings'}</span>
                            </div>
                            <div id="ratingDetails" class="rating-details"></div>
                            ${app.socialLink ? `<p class="text-gray-700 mt-2">Developer Link: <a href="${app.socialLink}" target="_blank" class="text-blue-600 hover:underline">${app.socialLink}</a></p>` : ''}
                        </div>
                        <div class="mt-6 star-rating flex space-x-1 items-center justify-center">
                            <span class="text-gray-700 mr-2 text-sm sm:text-base">Rate this app:</span>
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                    </div>
                    <div class="footer-buttons">
                        <button id="downloadBtn" onclick="incrementDownload('${docId}', '${app.apkLink}', '${user?.uid || 'anonymous'}')" class="bg-blue-600 text-white font-bold ${hasDownloaded ? 'downloaded' : ''}">Download APK</button>
                        <button onclick="shareWebsite()" class="bg-green-600 text-white font-bold">Share Website</button>
                        ${isOwner ? `
                            <button onclick="showUpdateForm('${docId}')" class="bg-yellow-500 text-white font-bold">Edit App</button>
                            <button onclick="handleDelete('${docId}')" class="bg-red-500 text-white font-bold">Delete App</button>
                        ` : ''}
                    </div>
                </div>
            `;
            setupRating(docId, user ? user.uid : null);
            loadRatingDetails(docId);
        }

        function showUploadForm() {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="flex-1 flex flex-col h-full">
                    <div class="app-bar">
                        <div class="flex items-center">
                            <button onclick="showHomePage()" class="mr-4 text-white hover:opacity-80 focus:outline-none">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 class="text-xl sm:text-2xl font-bold text-white">Upload App</h2>
                        </div>
                    </div>
                    <div class="p-6 flex-1 app-content">
                        <div id="messageArea" class="hidden"></div>
                        <form id="uploadForm" class="space-y-4 sm:space-y-6">
                            <div>
                                <label for="appIcon" class="block text-sm font-medium text-gray-700 mb-1">App Icon URL</label>
                                <input type="url" id="appIcon" placeholder="https://example.com/icon.png" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base" required>
                            </div>
                            <div>
                                <label for="appName" class="block text-sm font-medium text-gray-700 mb-1">App Name</label>
                                <input type="text" id="appName" placeholder="My Awesome App" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon text text-sm sm:text-base" required>
                            </div>
                            <div>
                                <label for="appApk" class="block text-sm font-medium text-gray-700 mb-1">APK Download Link</label>
                                <input type="url" id="appApk" placeholder="https://example.com/app.apk" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base" required>
                            </div>
                            <div>
                                <label for="appCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="appCategory" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" required>
                                    <option value="" disabled selected>Select Category</option>
                                    <option value="Games">Games</option>
                                    <option value="Productivity">Productivity</option>
                                    <option value="Social">Social</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Education">Education</option>
                                    <option value="Utilities">Utilities</option>
                                </select>
                            </div>
                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-gray-700">Screenshots URLs (3 required)</label>
                                <input type="url" id="screenshot1" placeholder="Screenshot 1 URL" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base" required>
                                <input type="url" id="screenshot2" placeholder="Screenshot 2 URL" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base" required>
                                <input type="url" id="screenshot3" placeholder="Screenshot 3 URL" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base" required>
                            </div>
                            <div>
                                <label for="appDescription" class="block text-sm font-medium text-gray-700 mb-1">App Description</label>
                                <textarea id="appDescription" placeholder="Describe your app..." class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" rows="6" required></textarea>
                            </div>
                            <div>
                                <label for="socialLink" class="block text-sm font-medium text-gray-700 mb-1">Telegram/YouTube Link (Optional)</label>
                                <input type="url" id="socialLink" placeholder="https://t.me/yourgroup or https://youtube.com/yourchannel" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url text-sm sm:text-base">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white p-3 sm:p-4 rounded-xl hover:bg-blue-700 flutter-button font-bold text-base sm:text-lg">Publish App</button>
                        </form>
                    </div>
                </div>
            `;
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', handleUpload);
            }
        }

        async function showUpdateForm(appId) {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }

            appContainer.innerHTML = `
                <div id="loadingIndicator" class="flex justify-center items-center h-full">
                    <svg class="w-8 h-8 text-gray-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg>
                    <span class="ml-3 text-gray-600">Loading App Data...</span>
                </div>`;
            
            try {
                const appRef = doc(db, 'apps', appId);
                const appSnap = await getDoc(appRef);

                if (!appSnap.exists()) {
                    showMessage('error', 'App not found.');
                    showManageApps();
                    return;
                }

                const app = appSnap.data();
                const user = JSON.parse(localStorage.getItem('user'));

                if (!user || user.uid !== app.userId) {
                    showMessage('error', 'You do not have permission to edit this app.');
                    showManageApps();
                    return;
                }

                appContainer.innerHTML = `
                    <div class="flex-1 flex flex-col h-full">
                        <div class="app-bar">
                            <div class="flex items-center">
                                <button onclick="showManageApps()" class="mr-4 text-white hover:opacity-80 focus:outline-none">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                </button>
                                <h2 class="text-xl sm:text-2xl font-bold text-white truncate">Edit: ${app.name}</h2>
                            </div>
                        </div>
                        <div class="p-6 flex-1 app-content">
                            <div id="messageArea" class="hidden"></div>
                            <form id="updateForm" class="space-y-4 sm:space-y-6">
                                <div><label for="appIcon" class="block text-sm font-medium text-gray-700 mb-1">App Icon URL</label><input type="url" id="appIcon" value="${app.icon}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url" required></div>
                                <div><label for="appName" class="block text-sm font-medium text-gray-700 mb-1">App Name</label><input type="text" id="appName" value="${app.name}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon text" required></div>
                                <div><label for="appApk" class="block text-sm font-medium text-gray-700 mb-1">APK Download Link</label><input type="url" id="appApk" value="${app.apkLink}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url" required></div>
                                <div><label for="appCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label><select id="appCategory" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" required><option value="" disabled>Select Category</option><option value="Games">Games</option><option value="Productivity">Productivity</option><option value="Social">Social</option><option value="Entertainment">Entertainment</option><option value="Education">Education</option><option value="Utilities">Utilities</option></select></div>
                                <div class="space-y-3"><label class="block text-sm font-medium text-gray-700">Screenshots URLs</label><input type="url" id="screenshot1" value="${app.screenshots[0] || ''}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url" required><input type="url" id="screenshot2" value="${app.screenshots[1] || ''}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url" required><input type="url" id="screenshot3" value="${app.screenshots[2] || ''}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url" required></div>
                                <div><label for="appDescription" class="block text-sm font-medium text-gray-700 mb-1">App Description</label><textarea id="appDescription" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6" required>${app.description}</textarea></div>
                                <div><label for="socialLink" class="block text-sm font-medium text-gray-700 mb-1">Telegram/YouTube Link (Optional)</label><input type="url" id="socialLink" value="${app.socialLink || ''}" class="w-full p-3 sm:p-4 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 input-icon url"></div>
                                <button type="submit" class="w-full bg-green-600 text-white p-3 sm:p-4 rounded-xl hover:bg-green-700 flutter-button font-bold text-base sm:text-lg">Save Changes</button>
                            </form>
                        </div>
                    </div>
                `;

                document.getElementById('appCategory').value = app.category;
                document.getElementById('updateForm').addEventListener('submit', (e) => handleUpdate(e, appId));

            } catch (error) {
                console.error('Error fetching app for update:', error);
                showMessage('error', `Failed to load app data: ${error.message}`);
                showManageApps();
            }
        }


        function showManageApps() {
            cleanupListeners();
            const appContainer = document.getElementById('app');
            if (!appContainer) {
                console.error('App container not found');
                return;
            }
            appContainer.innerHTML = `
                <div class="flex-1 flex flex-col h-full">
                    <div class="app-bar">
                        <div class="flex items-center">
                            <button onclick="showHomePage()" class="mr-4 text-white hover:opacity-80 focus:outline-none">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 class="text-xl sm:text-2xl font-bold text-white">Manage Your Apps</h2>
                        </div>
                    </div>
                    <div class="p-6 flex-1 app-content">
                        <div id="messageArea" class="hidden"></div>
                        <div id="loadingIndicator" class="hidden">
                            <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                            </svg>
                            <span>Loading Your Apps...</span>
                        </div>
                        <div id="manageAppList" class="space-y-4 sm:space-y-6"></div>
                        <div id="noUserApps" class="text-center text-gray-600 mt-6 sm:mt-8 hidden text-sm sm:text-base">You haven't uploaded any apps yet.</div>
                    </div>
                </div>
            `;
            loadUserApps();
        }

        // --- Authentication Handlers ---

        function handleSignUp(e) {
            e.preventDefault();
            const emailInput = document.getElementById('signupEmail');
            const passwordInput = document.getElementById('signupPassword');
            const usernameInput = document.getElementById('signupUsername');

            const email = emailInput?.value.trim();
            const password = passwordInput?.value.trim();
            const username = usernameInput?.value.trim();

            if (!email || !password || !username) {
                showMessage('error', 'Please fill all fields.');
                if (!email) emailInput?.classList.add('border-red-500'); else emailInput?.classList.remove('border-red-500');
                if (!password) passwordInput?.classList.add('border-red-500'); else passwordInput?.classList.remove('border-red-500');
                if (!username) usernameInput?.classList.add('border-red-500'); else usernameInput?.classList.remove('border-red-500');
                return;
            }

            if (password.length < 6) {
                showMessage('error', 'Password should be at least 6 characters.');
                passwordInput?.classList.add('border-red-500');
                return;
            } else {
                passwordInput?.classList.remove('border-red-500');
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Save user data to Firestore
                    setDoc(doc(db, 'users', user.uid), {
                        email: email,
                        displayName: username,
                        blocked: false,
                        createdAt: new Date()
                    });
                    localStorage.setItem('user', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        displayName: username
                    }));
                    showMessage('success', 'Account created successfully!');
                    setTimeout(showHomePage, 1000);
                })
                .catch((error) => {
                    console.error('Signup Error:', error);
                    showMessage('error', `Signup failed: ${error.message}`);
                });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');

            const email = emailInput?.value.trim();
            const password = passwordInput?.value.trim();

            if (!email || !password) {
                showMessage('error', 'Please fill all fields.');
                if (!email) emailInput?.classList.add('border-red-500'); else emailInput?.classList.remove('border-red-500');
                if (!password) passwordInput?.classList.add('border-red-500'); else passwordInput?.classList.remove('border-red-500');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Fetch display name from Firestore for consistency
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                const displayName = userDoc.exists() ? userDoc.data().displayName : user.email;

                localStorage.setItem('user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: displayName
                }));
                showMessage('success', 'Login successful!');
                setTimeout(showHomePage, 1000);
            } catch (error) {
                console.error('Login Error:', error);
                showMessage('error', `Login failed: ${error.message}`);
            }
        }

        function handleLogout() {
            signOut(auth)
                .then(() => {
                    localStorage.removeItem('user');
                    showMessage('success', 'Logged out successfully!', 2000);
                    showLoginPage();
                })
                .catch((error) => {
                    console.error('Logout Error:', error);
                    showMessage('error', `Logout failed: ${error.message}`);
                });
        }

        // --- App Data Handlers ---

        async function checkIfDownloaded(appId, userId) {
            if (!userId || userId === 'anonymous') return false;
            const downloadRef = doc(db, 'downloads', `${appId}_${userId}`);
            const downloadSnap = await getDoc(downloadRef);
            return downloadSnap.exists();
        }

        async function incrementDownload(docId, apkLink, userId) {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn || downloadBtn.disabled) return;

            downloadBtn.disabled = true;
            downloadBtn.classList.add('loading');

            if (!userId || userId === 'anonymous') {
                showMessage('info', 'Please log in to download this app.');
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('loading');
                return;
            }

            const hasDownloaded = await checkIfDownloaded(docId, userId);

            try {
                if (hasDownloaded) {
                    showMessage('info', 'You have already downloaded this app. Opening link again...', 3000);
                    window.open(apkLink, '_blank');
                } else {
                    // Mark as downloaded for this user
                    await setDoc(doc(db, 'downloads', `${docId}_${userId}`), {
                        userId: userId,
                        appId: docId,
                        timestamp: new Date()
                    });

                    // Increment download count only for the first download
                    const appRef = doc(db, 'apps', docId);
                    await updateDoc(appRef, {
                        downloads: increment(1)
                    });

                    showMessage('success', 'Download count increased! Link opened.', 3000);
                    downloadBtn.classList.add('downloaded');
                    window.open(apkLink, '_blank');
                }
            } catch (error) {
                console.error('Error updating download count:', error);
                showMessage('error', `Failed to download: ${error.message}. Please try again.`, 5000);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('loading');
            }
        }

        async function handleRating(docId, userId, rating) {
            if (!userId) {
                showMessage('info', 'Please log in to rate this app.');
                return;
            }

            try {
                await setDoc(doc(db, 'apps', docId, 'ratings', userId), {
                    rating: rating,
                    timestamp: new Date(),
                    userId: userId
                });
                showMessage('success', 'Rating submitted successfully!', 3000);
                loadRatingDetails(docId);
            } catch (error) {
                console.error('Error submitting rating:', error);
                showMessage('error', `Error submitting rating: ${error.message}`, 5000);
            }
        }

        async function loadRatingDetails(docId) {
            const avgRatingElement = document.getElementById('avgRating');
            const ratingDetailsElement = document.getElementById('ratingDetails');
            if (!avgRatingElement || !ratingDetailsElement) {
                return;
            }
            try {
                const ratingsSnapshot = await getDocs(collection(db, 'apps', docId, 'ratings'));
                let total = 0;
                let count = 0;
                const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                ratingsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (typeof data.rating === 'number') {
                        total += data.rating;
                        count++;
                        ratingCounts[data.rating]++;
                    }
                });

                const avgRating = count > 0 ? (total / count).toFixed(1) : 'No ratings';
                avgRatingElement.textContent = avgRating;

                let ratingBreakdown = '<p class="text-gray-700">Rating Breakdown:</p>';
                ratingBreakdown += '<div class="space-y-1">';
                for (let i = 5; i >= 1; i--) {
                    const percentage = count > 0 ? (ratingCounts[i] / count * 100).toFixed(0) : 0;
                    ratingBreakdown += `
                        <div class="flex items-center">
                            <span class="text-gray-600 w-8">${i} ★</span>
                            <div class="flex-1 bg-gray-200 rounded h-2">
                                <div class="bg-yellow-400 rounded h-2" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-gray-600 ml-2">${ratingCounts[i]}</span>
                        </div>
                    `;
                }
                ratingBreakdown += '</div>';
                ratingBreakdown += `<p class="text-gray-700 mt-2">Total Ratings: ${count}</p>`;
                ratingDetailsElement.innerHTML = count > 0 ? ratingBreakdown : '<p class="text-gray-600">No ratings yet.</p>';

                try {
                    const appRef = doc(db, 'apps', docId);
                    await updateDoc(appRef, {
                        avgRating: avgRating === 'No ratings' ? 0 : parseFloat(avgRating),
                        ratingCount: count
                    });
                } catch(updateError) {
                    console.error('Error updating average rating on app document:', updateError);
                }
            } catch (error) {
                console.error('Error loading rating details:', error);
                avgRatingElement.textContent = 'Error';
                ratingDetailsElement.innerHTML = '<p class="text-red-600">Error loading ratings.</p>';
            }
        }

        function setupRating(docId, userId) {
            const stars = document.querySelectorAll('.star-rating .star');
            if (stars.length === 0) {
                return;
            }

            if (userId) {
                getDoc(doc(db, 'apps', docId, 'ratings', userId)).then(ratingDoc => {
                    if (ratingDoc.exists()) {
                        const userRating = ratingDoc.data().rating;
                        stars.forEach(star => {
                            if (parseInt(star.getAttribute('data-value')) <= userRating) {
                                star.classList.add('active');
                            }
                        });
                    }
                }).catch(console.error);
            }

            stars.forEach(star => {
                star.removeEventListener('click', handleStarClick);
                star.addEventListener('click', handleStarClick);
            });

            function handleStarClick() {
                const rating = parseInt(this.getAttribute('data-value'));
                handleRating(docId, userId, rating);
                stars.forEach(s => s.classList.remove('active'));
                for (let i = 0; i < rating; i++) {
                    stars[i].classList.add('active');
                }
            }
        }
        
        // --- CORRECTED: Function to share the main website cleanly ---
        function shareWebsite() {
            const shareUrl = window.location.origin; // Gets base URL, e.g., "https://yoursite.com"
            const shareTitle = 'TZPROAPKS';
            // The descriptive text WITHOUT the URL in it.
            const shareText = `Check out ${shareTitle}, a great place to find and share apps.`;
            // The text for the clipboard fallback, which SHOULD include the URL.
            const clipboardText = `${shareText} ${shareUrl}`;

            if (navigator.share) {
                navigator.share({
                    title: shareTitle,
                    text: shareText, // <-- This is just the clean text.
                    url: shareUrl,   // <-- The URL is passed here, separately.
                }).then(() => {
                    showMessage('success', 'Website shared successfully!', 3000);
                }).catch((error) => {
                    console.error('Web Share failed:', error);
                    copyToClipboard(clipboardText, shareUrl); 
                });
            } else {
                copyToClipboard(clipboardText, shareUrl);
            }
        }

        function copyToClipboard(text, fallbackUrl) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showMessage('success', 'Link copied to clipboard!', 3000))
                    .catch(() => showMessage('error', 'Failed to copy link. Please copy manually: ' + fallbackUrl, 5000));
            } else {
                showMessage('info', 'Clipboard API not supported. Please copy manually: ' + fallbackUrl, 8000);
            }
        }

        function renderApps(appsWithIds) {
            const appList = document.getElementById('appList');
            const noResults = document.getElementById('noResults');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!appList || !noResults || !loadingIndicator) {
                console.error('App list, no results, or loading indicator element not found during render');
                showLoading(false);
                return;
            }

            appList.innerHTML = '';
            showLoading(false);

            if (appsWithIds.length === 0) {
                noResults.classList.remove('hidden');
                appList.classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                appList.classList.remove('hidden');
                appsWithIds.forEach(appItem => {
                    const app = appItem.data;
                    const docId = appItem.id;
                    const appCard = `
                        <div class="bg-white p-3 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transform hover:-translate-y-1 transition duration-200 ease-in-out flutter-card flex flex-col items-center text-center text-sm" onclick='showAppDetails(${JSON.stringify(app)}, "${docId}")'>
                            <img src="${app.icon}" alt="${app.name}" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg sm:rounded-xl object-cover mb-2 sm:mb-3">
                            <h3 class="font-bold text-gray-900 text-xs sm:text-sm truncate w-full px-1 sm:px-2">${app.name}</h3>
                            ${app.isApproved ? '<div class="text-center"><span class="verified-badge">Verified</span></div>' : ''}
                            <p class="text-xs text-gray-600 mt-1">Downloads: ${app.downloads || 0}</p>
                            <p class="text-xs text-gray-600 mt-1">Rating: ${app.avgRating ? parseFloat(app.avgRating).toFixed(1) : 'N/A'}</p>
                        </div>
                    `;
                    appList.innerHTML += appCard;
                });
            }
        }

        function loadApps() {
            const appList = document.getElementById('appList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noResults = document.getElementById('noResults');

            if (!appList || !loadingIndicator || !noResults) {
                console.error('Required elements not found for loadApps');
                return;
            }

            appList.innerHTML = '';
            noResults.classList.add('hidden');
            showLoading(true);

            if (window.currentAppListener) {
                window.currentAppListener();
                window.currentAppListener = null;
            }
            window.currentAppListenerData = null;

            const unsubscribe = onSnapshot(collection(db, 'apps'), (snapshot) => {
                const appsWithIds = [];
                snapshot.forEach((doc) => {
                    appsWithIds.push({ id: doc.id, data: doc.data() });
                });

                window.currentAppListenerData = appsWithIds;

                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');
                const sortOption = document.getElementById('sortOption');

                const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
                const category = categoryFilter ? categoryFilter.value : '';
                const sort = sortOption ? sortOption.value : 'name-asc';

                filterAndRenderApps(appsWithIds, query, category, sort);
            }, (error) => {
                console.error('Error fetching apps:', error);
                showLoading(false);
                noResults.classList.remove('hidden');
                noResults.textContent = 'Error loading apps. Please try again.';
                appList.classList.add('hidden');
                window.currentAppListenerData = null;
            });

            window.currentAppListener = unsubscribe;
        }

        function filterAndRenderApps(appsWithIds, query, category, sort) {
            const appList = document.getElementById('appList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noResults = document.getElementById('noResults');

            if (!appList || !loadingIndicator || !noResults) {
                console.error('Rendering elements not found in filterAndRenderApps');
                showLoading(false);
                return;
            }

            let filteredApps = appsWithIds.filter(item => {
                const app = item.data;
                const matchesSearch = app.name.toLowerCase().includes(query);
                const matchesCategory = !category || app.category === category;
                return matchesSearch && matchesCategory;
            });

            filteredApps.sort((a, b) => {
                const appA = a.data;
                const appB = b.data;
                if (sort === 'name-asc') return appA.name.localeCompare(appB.name);
                if (sort === 'name-desc') return appB.name.localeCompare(appA.name);
                if (sort === 'downloads-desc') return (appB.downloads || 0) - (appA.downloads || 0);
                if (sort === 'rating-desc') {
                    const ratingA = appA.avgRating ? parseFloat(appA.avgRating) : 0;
                    const ratingB = appB.avgRating ? parseFloat(appB.avgRating) : 0;
                    return ratingB - ratingA;
                }
                return 0;
            });

            renderApps(filteredApps);
        }

        function setupSearchAndFilters() {
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const sortOption = document.getElementById('sortOption');

            if (!searchInput || !categoryFilter || !sortOption) {
                console.warn('Search, filter, or sort elements not found. Skipping setup.');
                return;
            }

            const triggerFilterSort = () => {
                if (window.currentAppListenerData) {
                    const query = searchInput.value.trim().toLowerCase();
                    const category = categoryFilter.value;
                    const sort = sortOption.value;
                    filterAndRenderApps(window.currentAppListenerData, query, category, sort);
                } else {
                    console.warn('Data not yet loaded by listener when filter/sort triggered.');
                    loadApps();
                }
            };

            searchInput.addEventListener('input', debounce(triggerFilterSort, 300));
            categoryFilter.addEventListener('change', triggerFilterSort);
            sortOption.addEventListener('change', triggerFilterSort);
        }

        function loadUserApps() {
            const manageAppList = document.getElementById('manageAppList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noUserApps = document.getElementById('noUserApps');

            if (!manageAppList || !loadingIndicator || !noUserApps) {
                console.error('Manage app list, loading, or no user apps element not found');
                return;
            }

            manageAppList.innerHTML = '';
            noUserApps.classList.add('hidden');
            showLoading(true);

            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.uid) {
                console.error('User not found or not logged in');
                showLoading(false);
                noUserApps.classList.remove('hidden');
                noUserApps.textContent = 'Please log in to manage your apps.';
                return;
            }

            if (window.currentUserAppsListener) {
                window.currentUserAppsListener();
                window.currentUserAppsListener = null;
            }

            const q = query(collection(db, "apps"), where("userId", "==", user.uid));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!document.getElementById('manageAppList')) {
                    console.warn('Manage app list no longer exists, stopping listener update.');
                    unsubscribe();
                    window.currentUserAppsListener = null;
                    return;
                }
                
                showLoading(false);
                manageAppList.innerHTML = '';

                if (snapshot.empty) {
                    noUserApps.classList.remove('hidden');
                    noUserApps.textContent = 'You haven\'t uploaded any apps yet.';
                } else {
                    noUserApps.classList.add('hidden');
                    snapshot.forEach((doc) => {
                        const app = doc.data();
                        const appCard = `
                            <div class="bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 hover:shadow-xl transform hover:-translate-y-1 transition duration-200 ease-in-out flutter-card text-sm sm:text-base">
                                <img src="${app.icon}" alt="${app.name}" class="w-14 h-14 sm:w-16 sm:h-16 rounded-lg sm:rounded-xl object-cover flex-shrink-0">
                                <div class="flex-grow min-w-0">
                                    <h3 class="font-bold text-gray-900 text-base sm:text-lg truncate">${app.name}</h3>
                                    <p class="text-xs text-gray-600 mt-1">Downloads: ${app.downloads || 0}</p>
                                    <p class="text-xs text-gray-600 mt-1">Category: ${app.category || 'N/A'}</p>
                                    <p class="text-xs text-gray-600 mt-1">Rating: ${app.avgRating ? parseFloat(app.avgRating).toFixed(1) : 'N/A'}</p>
                                    ${app.isApproved ? '<span class="verified-badge mt-1">Verified</span>' : ''}
                                </div>
                                <div class="flex-shrink-0 ml-auto flex flex-col space-y-2">
                                    <button onclick="showUpdateForm('${doc.id}')" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 flutter-button text-xs sm:text-sm font-semibold">Edit</button>
                                    <button onclick="handleDelete('${doc.id}')" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 flutter-button text-xs sm:text-sm font-semibold">Delete</button>
                                </div>
                            </div>
                        `;
                        manageAppList.innerHTML += appCard;
                    });
                }
            }, (error) => {
                console.error('Error fetching user apps:', error);
                showLoading(false);
                noUserApps.classList.remove('hidden');
                noUserApps.textContent = 'Error loading your apps. Please try again.';
            });

            window.currentUserAppsListener = unsubscribe;
        }

        async function handleUpload(e) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.uid) {
                showMessage('info', 'Please log in to upload an app.');
                return;
            }

            const iconInput = document.getElementById('appIcon');
            const nameInput = document.getElementById('appName');
            const apkLinkInput = document.getElementById('appApk');
            const categoryInput = document.getElementById('appCategory');
            const screenshot1Input = document.getElementById('screenshot1');
            const screenshot2Input = document.getElementById('screenshot2');
            const screenshot3Input = document.getElementById('screenshot3');
            const descriptionInput = document.getElementById('appDescription');
            const socialLinkInput = document.getElementById('socialLink');

            const icon = iconInput?.value.trim();
            const name = nameInput?.value.trim();
            const apkLink = apkLinkInput?.value.trim();
            const category = categoryInput?.value;
            const screenshot1 = screenshot1Input?.value.trim();
            const screenshot2 = screenshot2Input?.value.trim();
            const screenshot3 = screenshot3Input?.value.trim();
            const description = descriptionInput?.value.trim();
            const socialLink = socialLinkInput?.value.trim() || null;

            let isValid = true;
            [iconInput, nameInput, apkLinkInput, categoryInput, screenshot1Input, screenshot2Input, screenshot3Input, descriptionInput].forEach(input => {
                if (input && !input.value.trim()) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input?.classList.remove('border-red-500');
                }
            });

            if (!isValid) {
                showMessage('error', 'Please fill all required fields.');
                return;
            }

            try {
                await addDoc(collection(db, 'apps'), {
                    icon: icon,
                    name: name,
                    apkLink: apkLink,
                    category: category,
                    screenshots: [screenshot1, screenshot2, screenshot3],
                    description: description,
                    downloads: 0,
                    userId: user.uid,
                    userEmail: user.email,
                    createdAt: new Date(),
                    isApproved: false, // Default to unapproved
                    socialLink: socialLink // Optional social link
                });

                showMessage('success', `${name} published successfully!`, 3000);
                e.target.reset();
                [iconInput, nameInput, apkLinkInput, categoryInput, screenshot1Input, screenshot2Input, screenshot3Input, descriptionInput, socialLinkInput].forEach(input => {
                    input?.classList.remove('border-red-500');
                });
            } catch (error) {
                console.error('Upload Error:', error);
                showMessage('error', `Failed to publish app: ${error.message}`, 5000);
            }
        }
        
        async function handleUpdate(e, docId) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.uid) {
                showMessage('info', 'Your session has expired. Please log in again.');
                return;
            }

            const iconInput = document.getElementById('appIcon');
            const nameInput = document.getElementById('appName');
            const apkLinkInput = document.getElementById('appApk');
            const categoryInput = document.getElementById('appCategory');
            const screenshot1Input = document.getElementById('screenshot1');
            const screenshot2Input = document.getElementById('screenshot2');
            const screenshot3Input = document.getElementById('screenshot3');
            const descriptionInput = document.getElementById('appDescription');
            const socialLinkInput = document.getElementById('socialLink');

            const updatedData = {
                icon: iconInput?.value.trim(),
                name: nameInput?.value.trim(),
                apkLink: apkLinkInput?.value.trim(),
                category: categoryInput?.value,
                screenshots: [
                    screenshot1Input?.value.trim(),
                    screenshot2Input?.value.trim(),
                    screenshot3Input?.value.trim()
                ],
                description: descriptionInput?.value.trim(),
                socialLink: socialLinkInput?.value.trim() || null
            };

            let isValid = true;
            [iconInput, nameInput, apkLinkInput, categoryInput, screenshot1Input, screenshot2Input, screenshot3Input, descriptionInput].forEach(input => {
                if (input && !input.value.trim()) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input?.classList.remove('border-red-500');
                }
            });

            if (!isValid) {
                showMessage('error', 'Please fill all required fields.');
                return;
            }

            try {
                const appRef = doc(db, 'apps', docId);
                await updateDoc(appRef, updatedData);
                showMessage('success', 'App updated successfully!', 3000);
                setTimeout(showManageApps, 1000);
            } catch (error) {
                console.error('Update Error:', error);
                showMessage('error', `Failed to update app: ${error.message}`, 5000);
            }
        }

        async function handleDelete(docId) {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.uid) {
                showMessage('info', 'You must be logged in to delete apps.');
                return;
            }

            if (confirm('Are you sure you want to delete this app? This action cannot be undone.')) {
                try {
                    // Note: This does not delete subcollections like 'ratings'.
                    // A Cloud Function is required for that.
                    await deleteDoc(doc(db, 'apps', docId));
                    showMessage('success', 'App deleted successfully!', 3000);
                } catch (error) {
                    console.error('Delete Error:', error);
                    showMessage('error', `Failed to delete app: ${error.message}`, 5000);
                }
            }
        }

        // --- Listener Management ---

        window.currentAppListener = null;
        window.currentAppListenerData = null;
        window.currentUserAppsListener = null;

        function cleanupListeners() {
            if (window.currentAppListener) {
                window.currentAppListener();
                window.currentAppListener = null;
                window.currentAppListenerData = null;
                console.log('App list listener cleaned up.');
            }

            if (window.currentUserAppsListener) {
                window.currentUserAppsListener();
                window.currentUserAppsListener = null;
                console.log('User apps listener cleaned up.');
            }

            clearTimeout(messageTimeout);
            showLoading(false);
        }

        // --- Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                // Handle auth state and update local storage accurately
                if (user) {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    const displayName = userDoc.exists() ? userDoc.data().displayName : user.displayName || user.email;

                    localStorage.setItem('user', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        displayName: displayName
                    }));
                } else {
                    localStorage.removeItem('user');
                }

                // Handle routing (including deep links from shares)
                const path = window.location.pathname;
                const appMatch = path.match(/^\/app\/([a-zA-Z0-9]+)$/);

                if (appMatch && appMatch[1]) {
                    const appId = appMatch[1];
                    // Clean URL to prevent issues on refresh/navigation within the SPA
                    history.replaceState(null, '', '/');
                    try {
                        const appRef = doc(db, 'apps', appId);
                        const appSnap = await getDoc(appRef);
                        if (appSnap.exists()) {
                            showAppDetails(appSnap.data(), appId);
                        } else {
                            if (user) showHomePage(); else showLoginPage();
                            setTimeout(() => showMessage('error', 'The requested app could not be found.', 4000), 100);
                        }
                    } catch (error) {
                        console.error("Error fetching deep-linked app:", error);
                        if (user) showHomePage(); else showLoginPage();
                        setTimeout(() => showMessage('error', 'Error loading the requested app.', 4000), 100);
                    }
                } else {
                    // Normal flow (no deep link)
                    if (user) {
                        showHomePage();
                    } else {
                        showLoginPage();
                    }
                }
            });
        });

        // --- Admin Approval Function (Example) ---
        // Note: This is a manual method. You can create an Admin UI separately.
        window.approveApp = async function(docId) {
            try {
                const appRef = doc(db, 'apps', docId);
                await updateDoc(appRef, { isApproved: true });
                showMessage('success', 'App approved successfully!', 3000);
            } catch (error) {
                console.error('Error approving app:', error);
                showMessage('error', `Failed to approve app: ${error.message}`, 5000);
            }
        };

        // --- Global Exposure ---

        window.showLoginPage = showLoginPage;
        window.showSignUpPage = showSignUpPage;
        window.showHomePage = showHomePage;
        window.handleLogout = handleLogout;
        window.showUploadForm = showUploadForm;
        window.showManageApps = showManageApps;
        window.toggleDrawer = toggleDrawer;
        window.closeDrawer = closeDrawer;
        window.showAppDetails = showAppDetails;
        window.incrementDownload = incrementDownload;
        window.handleDelete = handleDelete;
        window.shareWebsite = shareWebsite;
        window.showUpdateForm = showUpdateForm;
        window.handleUpdate = handleUpdate;
    </script>
</body>
</html>
